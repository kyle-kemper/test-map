<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CaniX Test Map</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
        }

        h2 {
            margin: 12px;
        }

        #map {
            height: 72vh;
            width: 100%;
        }

        /* ================= FILTER BAR ================= */
        #filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 14px;
            background: #f4f4f4;
            border-bottom: 2px solid #ddd;
            align-items: center;
        }

        #filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            padding: 6px 8px;
        }

        .filter-item img {
            width: 40px;
            height: 40px;
        }

        .filter-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        input[type="date"], button {
            font-size: 16px;
            padding: 6px 10px;
        }

        /* ================= LEAFLET POPUPS ================= */
        .leaflet-popup-content {
            font-size: 16px;
            line-height: 1.4;
        }

        /* ================= MOBILE MODE ================= */
        @media (max-width: 600px) {
            body {
                font-size: 18px;
                padding-top: 6px;
            }

            h2 {
                font-size: 22px;
            }

            #filters {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px 18px;
                gap: 16px;
                font-size: 18px;
                position: sticky;
                top: 0;
                z-index: 1000;
                background: #f4f4f4;
            }

            #filter-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 14px;
            }

            .filter-item {
                font-size: 18px;
                padding: 10px 14px;
                background: #fff;
                border-radius: 10px;
                border: 1px solid #ccc;
            }

            .filter-item img {
                width: 56px;
                height: 56px; 
            }

            .filter-item input[type="checkbox"] {
                width: 26px;
                height: 26px;
            }

            input[type="date"], button {
                font-size: 18px;
                padding: 10px 14px;
                width: 100%;
                max-width: 300px;
            }

            #map {
                height: 70vh;
            }

            /* BIG MOBILE POPUPS */
            .leaflet-popup {
                max-width: 320px;
            }

            .leaflet-popup-content {
                font-size: 19px;
                line-height: 1.5;
                margin: 14px;
            }

            .leaflet-popup-content strong {
                font-size: 20px;
            }

            .leaflet-popup-content-wrapper {
                border-radius: 14px;
            }

            .leaflet-popup-tip {
                transform: scale(1.3);
            }

            .leaflet-popup-close-button {
                font-size: 2200px;
                padding: 8px 10px;
            }

            .leaflet-control-zoom a {
                width: 52px;
                height: 52px;
                line-height: 52px;
                font-size: 26px;
            }
        }
    </style>
</head>
<body>

<h2>CaniX Locations Map v08</h2>

<div id="filters">
    <strong>Categories:</strong>
    <span id="filter-controls"></span>

    <strong>Filter by Date:</strong>
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="applyDateFilter()">Apply</button>
</div>

<div id="map"></div>

<script>
    const isMobile = window.innerWidth <= 600;

    const map = L.map('map').setView([39.5, -98.35], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    function customIcon(filename = "default") {
        let url;
        switch(filename) {
            case "nacclogo": url = "icons/nacclogo.png"; break;
            case "naccmeetup": url = "icons/naccmeetup.png"; break;
            case "crace": url = "icons/crace.png"; break;
            case "dograce": url = "icons/dograce.png"; break;
            default:
                url = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png";
        }

        const size = isMobile ? 90 : 60; // intentionally very large

        return new L.Icon({
            iconUrl: url,
            iconSize: [size, size],
            iconAnchor: [size / 2, size],
            popupAnchor: [0, -size / 2],
            shadowUrl: null
        });
    }

    const categoryLayers = {};
    const categoryIcons = {};
    const allMarkers = [];

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        return isNaN(d) ? null : d;
    }

    const iconMapping = {
        "NACC RACE": "nacclogo",
        "NACC Meet-Up": "naccmeetup",
        "Canicross Race": "crace",
        "Dog-Friendly Race": "dograce"
    };

    Papa.parse("pins.csv", {
        download: true,
        header: true,
        complete: function(results) {
            const filterContainer = document.getElementById("filter-controls");

            results.data.forEach(row => {
                if (!row.latitude || !row.longitude) return;

                const category = row.category || "Other";
                const iconType = iconMapping[category] || "default";

                if (!categoryLayers[category]) {
                    categoryLayers[category] = L.markerClusterGroup().addTo(map);
                    categoryIcons[category] = customIcon(iconType);

                    const id = `check-${category}`;
                    filterContainer.innerHTML += `
                        <label class="filter-item">
                            <input type="checkbox" id="${id}" checked onchange="toggleCategory('${category}')">
                            <img src="${categoryIcons[category].options.iconUrl}">
                            ${category}
                        </label>
                    `;
                }

                const marker = L.marker([
                    parseFloat(row.latitude),
                    parseFloat(row.longitude)
                ], { icon: categoryIcons[category] });

                const eventDate = parseDate(row.eventDate);
                marker.category = category;
                marker.eventDate = eventDate;

                marker.bindPopup(`
                    <strong>${row.name || "Unnamed"}</strong><br>
                    ${row.description || ""}<br>
                    <em>${category}</em><br>
                    ${eventDate ? `<strong>Date:</strong> ${eventDate.toDateString()}` : ""}
                `);

                categoryLayers[category].addLayer(marker);
                allMarkers.push(marker);
            });
        }
    });

    function toggleCategory(category) {
        const checkbox = document.getElementById(`check-${category}`);
        if (checkbox.checked) {
            map.addLayer(categoryLayers[category]);
        } else {
            map.removeLayer(categoryLayers[category]);
        }
    }

    function applyDateFilter() {
        const start = parseDate(document.getElementById("startDate").value);
        const end = parseDate(document.getElementById("endDate").value);

        for (const cat in categoryLayers) {
            categoryLayers[cat].clearLayers();
        }

        allMarkers.forEach(marker => {
            const cat = marker.category;
            const checkbox = document.getElementById(`check-${cat}`);
            let ok = true;

            if (start && marker.eventDate && marker.eventDate < start) ok = false;
            if (end && marker.eventDate && marker.eventDate > end) ok = false;

            if (ok && checkbox.checked) {
                categoryLayers[cat].addLayer(marker);
            }
        });
    }
</script>

</body>
</html>
