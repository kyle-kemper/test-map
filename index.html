<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CaniX Locations Map</title> /* text shown in browser tab */

    <!-- ======================================================
         External Libraries
         ====================================================== -->

    <!-- Leaflet: core mapping library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- MarkerCluster: groups markers when zoomed out -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- PapaParse: reads CSV files in-browser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- ======================================================
         Page & UI Styling
         ====================================================== -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        /* --------------------
           Map container size
           --------------------
           This controls ONLY the map height on the page,
           not marker size or text size.
        */
        #map {
            height: 80vh;  /* Desktop map height */
            width: 100%;
        }

        /* --------------------
           Filter bar styling
           --------------------
           This controls the text size of:
           - category labels
           - date inputs
           - buttons
        */
        #filters {
            display: flex;
            flex-wrap: wrap;
            padding: 12px;
            margin-bottom: 8px;
            background: #f4f4f4;

            font-size: 16px; /* ðŸ‘ˆ DESKTOP filter text size */
        }

        .filter-item {
            margin-right: 18px;
            display: inline-flex;
            align-items: center;
        }

        .filter-item img {
            width: 26px;   /* icon shown next to checkbox */
            height: 26px;
            margin: 0 6px;
        }

        /* --------------------
           Popup text sizing
           --------------------
           This controls ALL Leaflet popup text
           unless you override with custom classes.
        */
        .leaflet-popup-content {
            font-size: 14px;   /* ðŸ‘ˆ DESKTOP popup text size */
            line-height: 1.4;
        }

        /* ======================================================
           Mobile Overrides
           ====================================================== */
        @media (max-width: 480px) {

            /* Taller map on phones */
            #map {
                height: 70vh;
            }

            /* Bigger UI text for tapping */
            #filters {
                font-size: 18px; /* ðŸ‘ˆ MOBILE filter text size */
            }

            /* Bigger popup text for readability */
            .leaflet-popup-content {
                font-size: 16px; /* ðŸ‘ˆ MOBILE popup text size */
            }
        }

        /* --------------------
           Optional popup element styling
           -------------------- */
        .popup-title {
            font-size: 16px;
            font-weight: bold;
        }

        .popup-category {
            font-size: 13px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            .popup-title {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>

<h2>CaniX Locations Map Dec 21</h2> /* text shown on web page */

<!-- ======================================================
     Filter Controls (top UI)
     ====================================================== -->
<div id="filters">
    <strong>Categories:</strong>&nbsp;
    <span id="filter-controls"></span>

    <br><br>

    <strong>Filter by Date:</strong>&nbsp;
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="applyDateFilter()">Apply</button>
</div>

<!-- Map container -->
<div id="map"></div>

<script>
/* ============================================================
   1. Map Initialization
   ============================================================ */

const map = L.map("map").setView([39.5, -98.35], 4); // Centered on US

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

/* ============================================================
   2. Marker Icon Configuration
   ============================================================ */

/**
 * Maps event categories to icon filenames.
 * Keeps icons consistent across markers and filter UI.
 */
const iconMapping = {
    "Canicross Race": "nacclogo",
    "NACC Meet-Up": "naccmeetup",
    "Canine OCR": "OCR",
    "Dog Friendly Trail Race": "trail"
};

/**
 * Create a Leaflet marker icon.
 *
 * ðŸ”´ THIS IS WHERE MARKER SIZE IS CONTROLLED ðŸ”´
 *
 * Marker size is NOT CSS.
 * Marker size is controlled ONLY here.
 */
function createIcon(key = "default") {

    // Detect small screens (phones)
    const isMobile = window.innerWidth <= 480;

    // ======================================================
    // ðŸ‘‡ MAIN MARKER SIZE CONTROLS ðŸ‘‡
    // Change these two numbers to tune marker size
    // ======================================================
    const size = isMobile ? 42 : 32; // mobile : desktop (pixels)

    const iconUrls = {
        nacclogo: "icons/nacclogo.png",
        naccmeetup: "icons/naccmeetup.png",
        OCR: "icons/OCR.png",
        trail: "icons/trail.png",
        default: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png"
    };

    return new L.Icon({
        iconUrl: iconUrls[key] || iconUrls.default,

        // Actual visible size of the marker
        iconSize: [size, size],

        // Point of the marker that touches the map
        // Usually half width, full height
        iconAnchor: [size / 2, size],

        // Where the popup opens relative to the marker
        popupAnchor: [0, -size + 4]
    });
}

/* ============================================================
   3. Data Containers
   ============================================================ */

// One marker cluster group per category
const categoryLayers = {};

// Cache icons so we only create them once per category
const categoryIcons = {};

// Flat list of all markers (used for date filtering)
const allMarkers = [];

/* ============================================================
   4. Helper Functions
   ============================================================ */

function parseDate(value) {
    if (!value) return null;
    const d = new Date(value);
    return isNaN(d) ? null : d;
}

/* ============================================================
   5. Load CSV + Build Markers
   ============================================================ */

Papa.parse("pins2.csv", {
    download: true,
    header: true,
    complete: function(results) {

        const filterUI = document.getElementById("filter-controls");

        results.data.forEach(row => {

            // Skip rows without valid coordinates
            if (!row.latitude || !row.longitude) return;

            const name = row.RaceName || "Unnamed Event";
            const category = row.EventType || "Other";
            const url = row.RaceURL || "";
            const eventDate = parseDate(row.StartDate);

            // First time seeing a category â†’ create layer + checkbox
            if (!categoryLayers[category]) {

                const iconKey = iconMapping[category] || "default";
                categoryIcons[category] = createIcon(iconKey);
                categoryLayers[category] = L.markerClusterGroup().addTo(map);

                const checkboxId = `check-${category}`;
                filterUI.innerHTML += `
                    <label class="filter-item">
                        <input type="checkbox" id="${checkboxId}" checked
                               onchange="toggleCategory('${category}')">
                        <img src="${categoryIcons[category].options.iconUrl}">
                        ${category}
                    </label>
                `;
            }

            // Create the marker
            const marker = L.marker(
                [parseFloat(row.latitude), parseFloat(row.longitude)],
                { icon: categoryIcons[category] }
            );

            marker.category = category;
            marker.eventDate = eventDate;

            // Popup HTML (text size controlled via CSS above)
            marker.bindPopup(`
                <div class="popup">
                    <div class="popup-title">${name}</div>
                    ${url ? `<a href="${url}" target="_blank">Event website</a><br>` : ""}
                    <div class="popup-category">${category}</div>
                    ${eventDate ? `<strong>Date:</strong> ${eventDate.toDateString()}` : ""}
                </div>
            `);

            categoryLayers[category].addLayer(marker);
            allMarkers.push(marker);
        });
    }
});

/* ============================================================
   6. Category Toggle Logic
   ============================================================ */

function toggleCategory(category) {
    const checkbox = document.getElementById(`check-${category}`);
    checkbox.checked
        ? map.addLayer(categoryLayers[category])
        : map.removeLayer(categoryLayers[category]);
}

/* ============================================================
   7. Date Filter Logic
   ============================================================ */

function applyDateFilter() {
    const start = parseDate(document.getElementById("startDate").value);
    const end = parseDate(document.getElementById("endDate").value);

    // Clear all cluster layers
    Object.values(categoryLayers).forEach(layer => layer.clearLayers());

    // Re-add markers that pass date + category filters
    allMarkers.forEach(marker => {
        const checkbox = document.getElementById(`check-${marker.category}`);
        if (!checkbox.checked) return;

        if (start && marker.eventDate && marker.eventDate < start) return;
        if (end && marker.eventDate && marker.eventDate > end) return;

        categoryLayers[marker.category].addLayer(marker);
    });
}
</script>

</body>
</html>
