<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CaniX Locations Map</title>

    <!-- ======================================================
         External Libraries
         ====================================================== -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- ======================================================
         Page & UI Styling
         ====================================================== -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        /* ======================================================
           ðŸ”´ MASTER UI SCALE (CSS SIDE)
           This must match the JS UI_SCALE value
           ====================================================== */
        :root {
            --ui-scale: 1; 
        }

        #map {
            height: 80vh;
            width: 100%;
        }

        #filters {
            display: flex;
            flex-wrap: wrap;
            padding: 12px;
            margin-bottom: 8px;
            background: #f4f4f4;

            /* Filter bar text scales with UI_SCALE */
            font-size: calc(16px * var(--ui-scale));
        }

        .filter-item {
            margin-right: 18px;
            display: inline-flex;
            align-items: center;
        }

        .filter-item img {
            width: calc(26px * var(--ui-scale));
            height: calc(26px * var(--ui-scale));
            margin: 0 6px;
        }

        /* ======================================================
           Popup text sizing (scales with UI_SCALE)
           ====================================================== */
        .leaflet-popup-content {
            font-size: calc(14px * var(--ui-scale));
            line-height: 1.4;
        }

        .popup-title {
            font-size: calc(16px * var(--ui-scale));
            font-weight: bold;
        }

        .popup-category {
            font-size: calc(13px * var(--ui-scale));
            opacity: 0.8;
        }

        /* ======================================================
           Mobile adjustments
           ====================================================== */
        @media (max-width: 480px) {
            #map {
                height: 70vh;
            }
        }
    </style>
</head>

<body>

<h2>CaniX Locations Map vDec 26b</h2>

<div id="filters">
    <strong>Categories:</strong>&nbsp;
    <span id="filter-controls"></span>
    <br><br>
    <strong>Filter by Date:</strong>&nbsp;
    <input type="date" id="DateStart">
    <input type="date" id="endDate">
    <button onclick="applyDateFilter()">Apply</button>
</div>

<div id="map"></div>

<script>
/* ============================================================
   ðŸ”´ MASTER UI SCALE (JS SIDE)
   Change THIS ONE VALUE to scale the entire UI
   ============================================================ */
const UI_SCALE = 1.5;   // Default 1.0, try 0.9, 1.1, 1.25, etc.

/* Sync JS scale into CSS variable */
document.documentElement.style.setProperty("--ui-scale", UI_SCALE);

/* ============================================================
   Map Initialization
   ============================================================ */
const map = L.map("map").setView([39.5, -98.35], 4);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

/* ============================================================
   Marker Icon Configuration
   ============================================================ */

/**
 * Icon filenames by category
 */
const iconMapping = {
    "Canicross Race": "canicrosslogo",
    "Ambassador Group Meetup": "naccmeetup",
    "Canine OCR": "OCR",
    "Dog Friendly Trail Race": "trail"
};

const iconUrls = {
    canicrosslogo: "icons/canicrosslogo.png",
    naccmeetup: "icons/nacclogo.png",
    OCR: "icons/OCR.png",
    trail: "icons/trail.png",
    default: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png"
};

/* ============================================================
   ðŸ”´ ZOOM-AWARE MARKER SIZING LOGIC
   ============================================================ */

/**
 * Base marker sizes at reference zoom level
 */
const BASE_MARKER_SIZE_DESKTOP = 30;
const BASE_MARKER_SIZE_MOBILE  = 40;

/**
 * Reference zoom level:
 * markers will be this size at this zoom
 */
const REFERENCE_ZOOM = 6;

/**
 * Calculate marker size based on:
 * - desktop vs mobile
 * - UI_SCALE
 * - current zoom level
 */
function getMarkerSize() {
    const isMobile = window.innerWidth <= 480;
    const base = isMobile ? BASE_MARKER_SIZE_MOBILE : BASE_MARKER_SIZE_DESKTOP;

    // Zoom scaling factor
    const zoomFactor = Math.pow(1.15, map.getZoom() - REFERENCE_ZOOM);

    return base * UI_SCALE * zoomFactor;
}

/**
 * Create a Leaflet icon using dynamic size
 */
function createIcon(key = "default") {
    const size = getMarkerSize();

    return new L.Icon({
        iconUrl: iconUrls[key] || iconUrls.default,
        iconSize: [size, size],
        iconAnchor: [size / 2, size],
        popupAnchor: [0, -size + 4]
    });
}

/* ============================================================
   Data Containers
   ============================================================ */
const categoryLayers = {};
const categoryIcons = {};
const allMarkers = [];

/* ============================================================
   Helpers
   ============================================================ */
function parseDate(value) {
    if (!value) return null;
    const d = new Date(value);
    return isNaN(d) ? null : d;
}

/* ============================================================
   Load CSV + Build Map
   ============================================================ */
Papa.parse("races_airtable_fetched.csv", {
    download: true,
    header: true,
    complete: function(results) {
        const filterUI = document.getElementById("filter-controls");

        results.data.forEach(row => {
            const lat = parseFloat(row.lat || row.Latitude || row.latitude);
            const lng = parseFloat(row.lng || row.Longitude || row.longitude);

if (isNaN(lat) || isNaN(lng)) return;
            const name = row.RaceName || "Unnamed Event";
            const category = row.EventType || "Other";
            const url = row.RaceURL || "";
            const eventDate = parseDate(row.DateStart);

            if (!categoryLayers[category]) {
                const iconKey = iconMapping[category] || "default";
                categoryIcons[category] = createIcon(iconKey);
                categoryLayers[category] = L.markerClusterGroup().addTo(map);

                filterUI.innerHTML += `
                    <label class="filter-item">
                        <input type="checkbox" id="check-${category}" checked
                               onchange="toggleCategory('${category}')">
                        <img src="${categoryIcons[category].options.iconUrl}">
                        ${category}
                    </label>
                `;
            }

            const marker = L.marker(
                [lat, lng],
                { icon: categoryIcons[category] }
            );

            marker.category = category;
            marker.eventDate = eventDate;

            marker.bindPopup(`
                <div class="popup">
                    <div class="popup-title">${name}</div>
                    ${url ? `<a href="${url}" target="_blank">Event website</a><br>` : ""}
                    <div class="popup-category">${category}</div>
                    ${eventDate ? `<strong>Date:</strong> ${eventDate.toDateString()}` : ""}
                </div>
            `);

            categoryLayers[category].addLayer(marker);
            allMarkers.push(marker);
        });
    }
});
/* kyle test lines here to stop sign */
    Papa.parse("ambassador_airtable_fetched.csv", {
    download: true,
    header: true,
    complete: function(results) {
        const filterUI = document.getElementById("filter-controls");

        results.data.forEach(row => {
            const lat = parseFloat(row.lat || row.Latitude || row.latitude);
            const lng = parseFloat(row.lng || row.Longitude || row.longitude);

if (isNaN(lat) || isNaN(lng)) return;
            const name = row.RaceName || "Unnamed Event";
            const category = row.EventType || "Other";
            const url = row.RaceURL || "";
            const eventDate = parseDate(row.DateStart);

            if (!categoryLayers[category]) {
                const iconKey = iconMapping[category] || "default";
                categoryIcons[category] = createIcon(iconKey);
                categoryLayers[category] = L.markerClusterGroup().addTo(map);

                filterUI.innerHTML += `
                    <label class="filter-item">
                        <input type="checkbox" id="check-${category}" checked
                               onchange="toggleCategory('${category}')">
                        <img src="${categoryIcons[category].options.iconUrl}">
                        ${category}
                    </label>
                `;
            }

            const marker = L.marker(
                [lat, lng],
                { icon: categoryIcons[category] }
            );

            marker.category = category;
            marker.eventDate = eventDate;

            marker.bindPopup(`
                <div class="popup">
                    <div class="popup-title">${name}</div>
                    ${url ? `<a href="${url}" target="_blank">Event website</a><br>` : ""}
                    <div class="popup-category">${category}</div>
                    ${eventDate ? `<strong>Date:</strong> ${eventDate.toDateString()}` : ""}
                </div>
            `);

            categoryLayers[category].addLayer(marker);
            allMarkers.push(marker);
        });
    }
});

/* ============================================================
   ðŸ”´ Update marker sizes when zoom changes
   ============================================================ */
map.on("zoomend", () => {
    for (const category in categoryLayers) {
        categoryIcons[category] = createIcon(iconMapping[category] || "default");

        categoryLayers[category].eachLayer(marker => {
            marker.setIcon(categoryIcons[category]);
        });
    }
});

/* ============================================================
   Filters
   ============================================================ */
function toggleCategory(category) {
    const checkbox = document.getElementById(`check-${category}`);
    checkbox.checked
        ? map.addLayer(categoryLayers[category])
        : map.removeLayer(categoryLayers[category]);
}

function applyDateFilter() {
    const start = parseDate(document.getElementById("DateStart").value);
    const end = parseDate(document.getElementById("endDate").value);

    Object.values(categoryLayers).forEach(layer => layer.clearLayers());

    allMarkers.forEach(marker => {
        const checkbox = document.getElementById(`check-${marker.category}`);
        if (!checkbox.checked) return;

        if (start && marker.eventDate && marker.eventDate < start) return;
        if (end && marker.eventDate && marker.eventDate > end) return;

        categoryLayers[marker.category].addLayer(marker);
    });
}
</script>

</body>
</html>
